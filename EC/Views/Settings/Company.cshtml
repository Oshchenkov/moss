@using System.Collections;
@using EC.Models;
@using EC.Models.Database;
@using EC.App_LocalResources;
@using EC.Constants;

@{
    ViewBag.Title = GlobalRes.CompanySettings;
    Layout = "~/Views/Shared/IndexPages/LayoutCasesNewReport.cshtml";

    var um = (UserModel)ViewBag.um;
    var user_id = um.ID;
    var role_id = um._user.role_id;
    bool is_valid_mediator = false;
    if (role_id == ECLevelConstants.level_supervising_mediator)
    {
        is_valid_mediator = true;
    }
    if (um._user.user_permissions_change_settings == 1)
    {
        is_valid_mediator = true;
    }
    var is_invalid_mediator = (!is_valid_mediator).ToString().ToLower();
    var cm = (CompanyModel)ViewBag.cm;
    int company_id = cm._company.id;
    if(string.IsNullOrEmpty(cm._company.path_en))
    {
        cm._company.path_en = "~/Content/img/logoDefaultCompany.png";
    }
    bool is_cc = ViewBag.is_cc;
    //is_cc = true;
    String class_ext = ViewBag.cc_extension;
}

<style>
    .deleteRootCauses {
        width: 10px;
        height: 10px;
        background-color:red;
    }
</style>

<div id="companyId" data-value="@company_id"></div>
<div id="userId" data-value="@user_id"></div>
<div class="blockSettings">
    <!--casesHeared-->
    @{
        int active = 3;
    }
    @Html.Partial("~/Views/Settings/partial/casesHeared.cshtml", active)
    <!--casesHeared-->

    <div class="contentSettings secondHeader">
        <div class="headerCompanyProfile">
            <div class="headerBlock">
                <div class="blockImg">
                    <form action="@Url.Action("AddLogoCompany")" method="post" enctype="multipart/form-data" onsubmit="return handleSubmit(this);">
                        <img id="logoCompany" src='@Url.Content(cm._company.path_en)' />
                        @if (is_valid_mediator)
                        {
                            <input type="file" accept="image/*" id="_file" name="_file" multiple="multiple" style="width: 1px;height: 1px;opacity: 0;" />
                        }
                    </form>
                    @if (is_valid_mediator)
                    { 
                    <div id="hoverCompanyPhoto">
                        <label class="newImageBtn">@GlobalRes.Newimage</label>
                    </div>
                    }
                </div>

                <div class="blockText">
                    <p class="title">@cm._company.company_nm</p>
                    <a href=@cm._company_subdomain>@cm._company_subdomain</a>
                </div>
            </div>
            <div class="menuCompanyProfile">
                <div class="settingMenuItems">
                    <h2 class="menuItem active">@GlobalRes.Departments</h2>
                    <h2 class="menuItem">@GlobalRes.Locations</h2>
                    @*<h2 class="menuItem">@GlobalRes.Languages</h2>*@
                    <h2 class="menuItem">@GlobalRes.IncidentTypes</h2>
                    <h2 class="menuItem">@GlobalRes.CaseRouting</h2>
                    <h2 class="menuItem">@GlobalRes.ReporterTypes</h2>
                    <h2 class="menuItem">@GlobalRes.Anonymity</h2>
                    <h2 class="menuItem">@GlobalRes.Outcomes</h2>
                    <h2 class="menuItem">@GlobalRes.RootCauses</h2>
                    @*
                    <h2 class="menuItem">@GlobalRes.SecondaryType</h2>
                    <h2 class="menuItem">@GlobalRes.CaseAdminDepartment</h2>
                    *@
                </div>
            </div><!--menuCompanyProfile-->
        </div>
    </div><!--contentSettings.secondHeader-->
    <div class="contentCompanyProfile contentCompanyProfile@{@class_ext}">
        <div class="contentSettings">
            <!--blockDepartments-->
            <div class="blockDepartments">
                @if (is_valid_mediator)
                {
                    <div class="addDepartmentBtn" id="addInputDep">
                        <!--After click Btn - add class inactive-->
                        <p>@GlobalRes.addnewDepartment</p>
                    </div>
                }
                <div class="addDepartmentBtn" id="addDepBtn" style="width: auto;">
                    <!--After click Btn - add class inactive-->
                    <p style="min-width: 50px;">@GlobalRes.Add</p>
                </div>
                <div class="addNewDepartment">
                    <input type="text" name="newDepartmenName" required="" value="">
                    <div class="closeIcon"></div>
                </div>
                <div class="tableDepartment">
                    @foreach (company_department _department in cm.CompanyDepartmentsActive(company_id))
                    {
                        <div style="display: flex;">
                            <p>@_department.department_en</p>
                            @if (is_valid_mediator)
                            {
                                <div data-value="@_department.id" class="deleteDepartment"></div>
                            }
                        </div>
                    }
                </div>
            </div><!--blockDepartments-->

            <!--blockLocations-->
            <div class="blockLocations" style="display: none;">
                @if (is_valid_mediator)
                {
                    <div class="addLocationBtn" id="addInputLoc">
                        <!--After click Btn - add class inactive-->
                        <p>@GlobalRes.addnewLocation</p>
                    </div>
                }
                <div class="addLocationBtn" id="addLocBtn" style="width: auto;">
                    <!--After click Btn - add class inactive-->
                    <p style=" min-width: 50px;">@GlobalRes.Add</p>
                </div>
                <div class="addNewLocation">
                    <input type="text" name="newLocationName" required="" value="">
                    @if (is_cc)
                    {
                        @Html.DropDownList("location_cc_extended", (SelectList) ViewBag.LocationExtendeds, "Not selected", new { @class = "select-def" })
                    }
                    <div class="closeIcon"></div>
                </div>
                <div class="tableLocation">
                    @foreach (company_location _location in cm.Locations(company_id, 2))
                    {
                        <div style="display: flex;">
                            <p>
                                <span class="location_name">@_location.location_en</span>
                                @if (is_cc)
                                {
                                    var list = (SelectList)ViewBag.LocationExtendeds;
                                    if (_location.location_cc_extended_id.HasValue)
                                    {
                                        list = new SelectList(list, "Value", "Text", _location.location_cc_extended_id.Value.ToString());
                                    }
                                    @Html.DropDownList("location_cc_extended_" + _location.id, list, "Not selected", new { @class = "location_cc_extended_items select-def" })
                                }
                            </p>
                            @if (is_valid_mediator)
                            {
                                <div data-value="@_location.id" class="deleteLocation"></div>
                            }
                        </div>
                    }
                </div>

            </div><!--blockLocations-->

            <div class="blockLanguages" style="display: none;">
                <p>This version is only available in English</p>
                <div class="tableLanguage">
                    <div style="display: flex;">
                        <p>@GlobalRes.English</p>
                    </div>
                </div>

            </div><!--blockLocations-->

            <div class="blockIncidentTypes" style="display: none;">
                 @if (is_valid_mediator)
                    {
                <div class="addIncidentTypeBtn" id="addInputIncType">
                    <!--After click Btn - add class inactive-->
                    <p>@GlobalRes.addnewIncidentType</p>
                </div>
                }
                <div class="addIncidentTypeBtn" id="addIncBtn" style="width: auto;">
                    <!--After click Btn - add class inactive-->
                    <p style=" min-width: 50px;">@GlobalRes.Add</p>
                </div>
                <div class="addNewIncidentType">
                    <input type="text" name="newIncidentTypeName" required="" value="">
                    <div class="closeIcon"></div>
                </div>
                <div class="tableIncidentType">
                    @foreach (DictionaryEntry _entry in cm.CompanyIncidentTypes(company_id))
                    {
                        <div style="display: flex;">
                            <p>@_entry.Value</p>
                            @if (is_valid_mediator)
                            {
                                <div class="deleteIncidentType" data-value="@_entry.Key"></div>
                            }
                        </div>
                    }

                </div>
            </div><!--blockIncidentTypes-->

            <div class="blockReporterTypes" style="display: none;">
                    @if (is_valid_mediator)
                    {
                    <div class="addReporterTypeBtn" id="addInputRepType">
                        <!--After click Btn - add class inactive-->
                        <p>@GlobalRes.addnewReporterType</p>
                    </div>
                    }
                <div class="addReporterTypeBtn" id="addRepBtn" style="width: auto;">
                    <!--After click Btn - add class inactive-->
                    <p style=" min-width: 50px;">@GlobalRes.Add</p>
                </div>
                <div class="addNewReporterType">
                    <input type="text" name="newReporterTypeName" required="" value="">
                    <div class="closeIcon"></div>
                </div>
                <div class="tableReporterType">
                    @foreach (DictionaryEntry _entry in cm.CompanyReporterTypes(company_id))
                    {
                        <div style="display: flex;">
                            <p>@_entry.Value</p>
                            @if (is_valid_mediator)
                            {
                                <div data-value="@_entry.Key" class="deleteReporterType"></div>
                            }
                        </div>
                    }

                </div>
            </div><!--blockReporterType-->

            <div class="blockAnonymity" style="display: none;">

                <div class="tableAnonymity">
                    @if (ViewBag.CA != null)
                    {
                        foreach (EC.Controllers.ViewModel.AnonimityViewModel item in ViewBag.CA)
                        {
                            <div style="display: flex;">
                                <p style="width: 88%;">@string.Format(item.anonymity.anonymity_en, cm._company.company_nm)</p>
                                <input type="checkbox" class="bigCheckBox" disabled checked="@item.isChecked" />
                                <div data-value="@item.anonymity.id"></div>
                            </div>

                        }

                    }
                </div>
            </div><!--blockReporterType-->

            <div class="blockOutcomes" style="display: none;">
                @if (is_valid_mediator)
                {
                    <div class="addOutcomeBtn" id="addInputOutcome">
                        <!--After click Btn - add class inactive-->
                        <p>@GlobalRes.addnewOutcome</p>
                    </div>
                }
                <div class="addOutcomeBtn" id="addOutBtn" style="width: auto;">
                    <!--After click Btn - add class inactive-->
                    <p style=" min-width: 50px;">@GlobalRes.Add</p>
                </div>
                <div class="addNewOutcome">
                    <input type="text" name="newOutcomeName" required="" value="">
                    <div class="closeIcon"></div>
                </div>
                <div class="tableOutcome tableReporterType">
                    @foreach (company_outcome _outcome in cm.Outcomes(company_id, 2))
                    {
                        <div style="display: flex;">
                            <p>@_outcome.outcome_en</p>
                            @if (is_valid_mediator)
                            {
                                <div data-value="@_outcome.id" class="deleteOutcome"></div>
                            }
                        </div>
                    }

                </div>
            </div><!--blockOutcome-->

            <div id="caseRouting" class="blockCaseRouting" style="display: none;" ng-controller="SettingsCompanyRoutingController">
                <div class="positionTableCases">
                    <p>Routing by Location</p>
                    <table class="tableCasesIndex">
                        <thead>
                            <tr>
                                <td width="300px">Location</td>
                                <td>Issue Owner</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="line in locationItems">
                                <td class="ng-binding">{{locationName(line.company_location_id).location_en}}</td>
                                <td class="inSelect">
                                    <select ng-change="changeLineLocation(line)" ng-model="line.user_id" ng-options="item.id as userName(item) for item in usersLocation" ng-disabled="@is_invalid_mediator">
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <p>Routing by Incident Type</p>
                    <table class="tableCasesIndex">
                        <thead>
                            <tr>
                                <td width="300px">Incident Type</td>
                                <td>Department</td>
                                <td>Issue Owner</td>
                                <td>Scope</td>
                                <td>Policy</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="line in items">
                                <td class="ng-binding">{{typeName(line.company_secondary_type_id).secondary_type_en}}</td>
                                <td class="inSelect">
                                    <select ng-change="changeLine(line)" ng-model="line.company_case_admin_department_id" ng-options="item.id as item.department_en for item in departments" ng-disabled="@is_invalid_mediator">
                                    </select>
                                </td>
                                <td class="inSelect">
                                    <select ng-change="changeLine(line)" ng-model="line.user_id" ng-options="item.id as userName(item) for item in users" ng-disabled="@is_invalid_mediator">
                                    </select>
                                </td>
                                <td class="inSelect">
                                    <select ng-change="changeLine(line)" ng-model="line.scope_id" ng-options="item.id as item.scope_en for item in scopes" ng-disabled="@is_invalid_mediator">
                                    </select>
                                </td>
                                <td class="ng-binding">
                                    <div class="button" ng-click="fileSelect(line)" onclick="$(this).parent().find('input').click()" ng-hide="@is_invalid_mediator">
                                        Upload
                                    </div>
                                    <input type="file" style="display: none;" onchange="angular.element(this).scope().upload(this); return false;">
                                    <div ng-repeat="file in files | filter: { company_case_routing_id: line.id }:true">
                                        <div>
                                            <span>
                                                <a href="{{file.path_nm}}">{{file.file_nm}}</a>
                                            </span>
                                            <span>
                                                <a href="#" ng-click="delete(file.id)" ng-hide="@is_invalid_mediator">X</a>
                                            </span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="blockRootCauses" style="display: none;">
                <table style="width: 100%;">
                    <tr>
                        <td width="33%">Behavioral Factors:</td>
                        <td width="33%">External Influences:</td>
                        <td width="33%">Organizational Influences:</td>
                    </tr>
                </table>

                <div class="tableLocation" style="">
                    <table style="width: 100%;" id="tblRootCauses" data-delete="@(is_valid_mediator ? 1 : 0)">
                        @{
                            List<company_root_cases_behavioral> list1 = (List<company_root_cases_behavioral>)ViewBag.Company_root_cases_behavioral;
                            List<company_root_cases_external> list2 = (List<company_root_cases_external>)ViewBag.Company_root_cases_external;
                            List<company_root_cases_organizational> list3 = (List<company_root_cases_organizational>)ViewBag.Company_root_cases_organizational;
                            var max = Math.Max(list1.Count, Math.Max(list2.Count, list3.Count));
                        }
                        @for (var i = 0; i < max; i++)
                        {
                            var item1 = list1.Count > i ? list1[i] : null;
                            var item2 = list2.Count > i ? list2[i] : null;
                            var item3 = list3.Count > i ? list3[i] : null;
                            <tr>
                                <td width="33%" data-id="@(item1 != null ? item1.id.ToString() : "")">
                                    @if (item1 != null)
                                    {
                                        <p>@item1.name_en</p>
                                        if (is_valid_mediator)
                                        {
                                            <div class="deleteRootCauses"></div>
                                        }
                                    }
                                </td>
                                <td width="33%" data-id="@(item2 != null ? item2.id.ToString() : "")">
                                    @if (item2 != null)
                                    {
                                        <p>@item2.name_en</p>
                                        if (is_valid_mediator)
                                        {
                                            <div class="deleteRootCauses"></div>
                                        }
                                    }
                                </td>
                                <td width="33%" data-id="@(item3 != null ? item3.id.ToString() : "")">
                                    @if (item3 != null)
                                    {
                                        <p>@item3.name_en</p>
                                        if (is_valid_mediator)
                                        {
                                            <div class="deleteRootCauses"></div>
                                        }
                                    }
                                </td>
                            </tr>
                        }
                        </table>
                    <table style="width: 100%;">
                        <tr>
                            <td width="33%">
                                <div class="newRootCauses" id="newRootCauses1" style="display: none; border-style: solid; border-width: 0px;">
                                    <input type="text" required="" value="" placeholder="Enter name">
                                    <div class="addLocationBtn" id="addLocBtn1" style="width: auto;">
                                        <p style="min-width: 50px;" class="btnAdd">@GlobalRes.Add</p>
                                    </div>
                                </div>
                            </td>
                            <td width="33%">
                                <div class="newRootCauses" id="newRootCauses2" style="display: none; border-style: solid; border-width: 0px;">
                                    <input type="text" required="" value="" placeholder="Enter name">
                                    <div class="addLocationBtn" id="addLocBtn1" style="width: auto;">
                                        <p style="min-width: 50px;" class="btnAdd">@GlobalRes.Add</p>
                                    </div>
                                </div>
                            </td>
                            <td width="33%">
                                <div class="newRootCauses" id="newRootCauses3" style="display: none; border-style: solid; border-width: 0px;">
                                    <input type="text" required="" value="" placeholder="Enter name">
                                    <div class="addLocationBtn" id="addLocBtn1" style="width: auto;">
                                        <p style="min-width: 50px;" class="btnAdd">@GlobalRes.Add</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            
                <table style="width: 100%;">
                    <tr>
                        <td width="33%">
                            @if (is_valid_mediator)
                            {
                                <div class="addLocationBtn" id="addNewRootCauses1">
                                    <p>@GlobalRes.AddNewBehavioralFactors</p>
                                </div>
                            }
                        </td>
                        <td width="33%">
                            @if (is_valid_mediator)
                            {
                                <div class="addLocationBtn" id="addNewRootCauses2">
                                    <p>@GlobalRes.AddNewExternalInfluences</p>
                                </div>
                            }
                        </td>
                        <td width="33%">
                            @if (is_valid_mediator)
                            {
                                <div class="addLocationBtn" id="addNewRootCauses3">
                                    <p>@GlobalRes.AddNewOrganizationalInfluences</p>
                                </div>
                            }
                        </td>
                    </tr>
                </table>
            </div>
        
            <div class="blockSecondaryType" style="display: none;" ng-controller="SettingsCompanySecondaryTypeController">
                @if (is_valid_mediator)
                {
                    <div class="addIncidentTypeBtn" ng-show="!addMode">
                        <p ng-click="addMode = !addMode">Add New Secondary Type</p>
                    </div>
                    <div class="addIncidentTypeBtn" ng-show="addMode">
                        <p style="min-width: 50px;" ng-click="add()">@GlobalRes.Add</p>
                    </div>
                }
                <div ng-show="addMode">
                    <p>Incident Type</p>
                    <select ng-model="addType" ng-options="item.id as item.secondary_type_en for item in secondaryTypes"></select>
                </div>
                <div class="addNewIncidentType" ng-show="addMode" style="display: block;">
                    <input type="text" name="newIncidentTypeName" required="" value="" ng-model="addName">
                    <div class="closeIcon"></div>
                </div>
                <div class="tableIncidentType">
                    <table style="width: 100%;">
                        <tr ng-repeat="item in third_level_types">
                            <td width="50%">
                                <p>{{item.third_level_type_name_en}}</p>
                                @if (is_valid_mediator)
                                {
                                    <div class="deleteRootCauses" ng-click="delete(item.id)"></div>
                                }
                            </td>
                            <td width="50%">{{findST(item.company_secondary_type_id)}}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="blockCaseAdminDepartment" style="display: none;" ng-controller="SettingsCompanyCaseAdminDepartmentController">
                @if (is_valid_mediator)
                {
                    <div class="addIncidentTypeBtn" ng-show="!addMode">
                        <p ng-click="addMode = !addMode">Add New Case Admin Department</p>
                    </div>
                    <div class="addIncidentTypeBtn" ng-show="addMode">
                        <p style="min-width: 50px;" ng-click="add()">@GlobalRes.Add</p>
                    </div>
                }
                <div class="addNewIncidentType" ng-show="addMode" style="display: block;">
                    <input type="text" name="newIncidentTypeName" required="" value="" ng-model="addName">
                    <div class="closeIcon"></div>
                </div>
                <div class="tableIncidentType">
                    <table style="width: 100%;">
                        <tr ng-repeat="item in case_admin_departments">
                            <td width="50%">
                                <p>{{item.name_en}}</p>
                                @if (is_valid_mediator)
                                {
                                    <div class="deleteRootCauses" ng-click="delete(item.id)"></div>
                                }
                            </td>
                        </tr>
                    </table>
                </div>

            </div><!--blockIncidentTypes-->

        </div><!--blockIncidentTypes-->
    </div><!--contentSettings-->
</div><!--contentCompanyProfile-->

<input type="hidden" id="urlAjaxUploadFiles" from="Company" value="@Url.Action("AddLogoCompany", "Settings")" />
<input type="hidden" id="sendAjax" value="@Url.Action("addNewfunction", "Settings")"/>